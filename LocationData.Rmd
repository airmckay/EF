---
title: "Site map - Marker windpark"
output: html_document
---
# Marker 2020 spatial data 

#Work environment 
```{r}

library(tidyverse)
library(dplyr)
library(raster)
library(rgdal)
library(rgeos)
library(mapview)
library(sf)
library(sp)
library(maps)
library(leaflet)
library(randomcoloR)
library(wesanderson)
library(leaflegend)
library(osmdata)
library(MetBrewer)
library(colorBlindness)
library(colorblindcheck)
library(ggmap)
library(maptools)

output <- "C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/5. EcoForest/Location Data/DigitalPoints"

## 
 file.name <- "MainSites"
# 
 todays_date <- Sys.Date()
# 
dir.name <- str_c(output,"/", file.name, "_", todays_date)
 dir.name
# 
 dir.create(dir.name) 
 # "C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/5. EcoForest/Location Data/DigitalPoints/MainSites_2023-05-31"

output_today <- dir.name
output_today

setwd(output_today)
getwd()

dim(tpt2)
dim(tpt1)

# Turbine locations
tpt<- read.csv("C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/5. EcoForest/Location Data/Sites_31052023.csv", sep = ";")
names(tpt)

tpt1 <- tpt

# Factorize useful columns 
tpt1$Lokalitet = as.factor(tpt1$Lokalitet)
tpt1$Site = as.factor(tpt1$Site)
tpt1$Kategori = as.factor(tpt1$Kategori)

# Example code for how to make another category based on existing factor levels
# tpt1 <- tpt %>% mutate(Monitoring = case_when(
#    Name %in% c("T-02", "T-04", "T-09", "T-10",  "T-14") ~ "AcousticsOnly",
#    Name %in% c("T-01", "T-03", "T-05", "T-06", "T-07", "T-12", "T-13", "T-15") ~ "Not Monitored", 
#    Name %in% c("T-08", "T-11") ~ "AcousticsAndCT") )

# tpt1$Monitoring = as.factor(tpt1$Monitoring)



```

# Convert lat long columns to spatial objects 
```{r}
tpt1 <- tpt %>% rename ("Lat" = "Coordinate.X0Y0..Lat.",  "Lon" = "Coordinate.X0Y0..Lon." )
tpt2 <- st_as_sf(tpt1,coords=c("Lon", "Lat"),crs = "+proj=latlong +ellps=WGS84 +datum=WGS84 +units=m +no_defs")
crs(tpt2$geometry)

# Check that these can be plotted 
plot(tpt2[1])

# More info on geo projections in R
# http://companion.soep.de/Working%20with%20SOEP%20Data/Working%20with%20spatial%20data%20in%20R.html

## Convert to UTM (easier to export)


dfutm <- sp::spTransform(tpt2, CRS("+proj=utm +zone=32 +datum=WGS84"))


```
*Back up option*
# Code / functions from : 
# https://stackoverflow.com/questions/18639967/converting-latitude-and-longitude-points-to-utm
LatLonToUTMEPSGCode <- function(lat, lon) {

  zone_number <- (floor((lon + 180) / 6) %% 60) + 1

  # Special zones for Norway
  cond_32 <- lat >= 56.0 & lat < 64.0 & lon >= 3.0 & lon < 12.0
  zone_number[cond_32] <- 32

  # Special zones for Svalbard
  cond_lat <- lat >= 72.0 & lat < 84.0

  cond_31 <- cond_lat & lon >= 0.0 & lon <  9.0
  zone_number[cond_31] <- 31

  cond_33 <- cond_lat & lon >= 9.0 & lon < 21.0
  zone_number[cond_33] <- 33

  cond_35 <- cond_lat & lon >= 21.0 & lon < 33.0
  zone_number[cond_35] <- 35

  cond_37 <- cond_lat & lon >= 33.0 & lon < 42.0
  zone_number[cond_37] <- 37

  # EPSG code
  utm <- zone_number
  utm[lat > 0] <- utm[lat > 0] + 32600
  utm[lat <= 0] <- utm[lat <= 0] + 32700

  return(utm)
}

sf_sample <- sf::st_as_sf(tpt2, coords = c("Lon", "Lat"),
                          crs = 4326)
sf_sample$Easting <- "" 
sf_sample$Northing <- "" 

df_utm <- sf_sample %>%
  do(cbind(., st_coordinates(.))) %>%
  mutate(EPSG = LatLonToUTMEPSGCode(lat = Y, lon = X)) %>%
  group_by(EPSG) %>%
  do(cbind(as.data.frame(.) %>% dplyr::select(Northing, Easting),
           st_coordinates(st_transform(., crs = head(.$EPSG, 1))))) 
%>% ungroup()


# Site Map 
```{r}

plot1 <- tpt2 %>% leaflet() %>% 
   addTiles() %>%
   addCircleMarkers(radius = 7, color = "gray",
                       fillOpacity = 0.5,  stroke = TRUE) %>% 
  addScaleBar(position = "bottomright")
plot1$x$options = append(plot1$x$options, list("zoomControl" = FALSE,  "scaleBar"=TRUE))
plot1 

```

# Export .gpx and .kmz files 
```{r}

# .GPX and KML files of main sites 
latslongs <- SpatialPointsDataFrame(coords=tpt1[,c(7, 8)],data=tpt1, proj4string =CRS("+proj=latlong +ellps=WGS84")) 
crs(latslongs) 
spTransform(latslongs, datum=WGS84 +no_defs +towgs84=0,0,0)
st_crs(latslongs)

writeOGR(latslongs, dsn= "C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/5. EcoForest/Location Data/DigitalPoints/MainSites_2023-05-31",
     dataset_options="GPX_USE_EXTENSIONS=yes",layer="waypoints",driver="GPX", overwrite_layer = T)

```

